
function screenOff() {
    importClass(android.graphics.Bitmap);
    importClass(android.graphics.Matrix);


}
//繁体转换为简体
const zh_s = '皑蔼碍爱翱袄奥坝罢摆败颁办绊帮绑镑谤剥饱宝报鲍辈贝钡狈备惫绷笔毕毙闭边编贬变辩辫鳖瘪濒滨宾摈饼拨钵铂驳卜补参蚕残惭惨灿苍舱仓沧厕侧册测层诧搀掺蝉馋谗缠铲产阐颤场尝长偿肠厂畅钞车彻尘陈衬撑称惩诚骋痴迟驰耻齿炽冲虫宠畴踌筹绸丑橱厨锄雏础储触处传疮闯创锤纯绰辞词赐聪葱囱从丛凑窜错达带贷担单郸掸胆惮诞弹当挡党荡档捣岛祷导盗灯邓敌涤递缔点垫电淀钓调迭谍叠钉顶锭订东动栋冻斗犊独读赌镀锻断缎兑队对吨顿钝夺鹅额讹恶饿儿尔饵贰发罚阀珐矾钒烦范贩饭访纺飞废费纷坟奋愤粪丰枫锋风疯冯缝讽凤肤辐抚辅赋复负讣妇缚该钙盖干赶秆赣冈刚钢纲岗皋镐搁鸽阁铬个给龚宫巩贡钩沟构购够蛊顾剐关观馆惯贯广规硅归龟闺轨诡柜贵刽辊滚锅国过骇韩汉阂鹤贺横轰鸿红后壶护沪户哗华画划话怀坏欢环还缓换唤痪焕涣黄谎挥辉毁贿秽会烩汇讳诲绘荤浑伙获货祸击机积饥讥鸡绩缉极辑级挤几蓟剂济计记际继纪夹荚颊贾钾价驾歼监坚笺间艰缄茧检碱硷拣捡简俭减荐槛鉴践贱见键舰剑饯渐溅涧浆蒋桨奖讲酱胶浇骄娇搅铰矫侥脚饺缴绞轿较秸阶节茎惊经颈静镜径痉竞净纠厩旧驹举据锯惧剧鹃绢杰洁结诫届紧锦仅谨进晋烬尽劲荆觉决诀绝钧军骏开凯颗壳课垦恳抠库裤夸块侩宽矿旷况亏岿窥馈溃扩阔蜡腊莱来赖蓝栏拦篮阑兰澜谰揽览懒缆烂滥捞劳涝乐镭垒类泪篱离里鲤礼丽厉励砾历沥隶俩联莲连镰怜涟帘敛脸链恋炼练粮凉两辆谅疗辽镣猎临邻鳞凛赁龄铃凌灵岭领馏刘龙聋咙笼垄拢陇楼娄搂篓芦卢颅庐炉掳卤虏鲁赂禄录陆驴吕铝侣屡缕虑滤绿峦挛孪滦乱抡轮伦仑沦纶论萝罗逻锣箩骡骆络妈玛码蚂马骂吗买麦卖迈脉瞒馒蛮满谩猫锚铆贸么霉没镁门闷们锰梦谜弥觅绵缅庙灭悯闽鸣铭谬谋亩钠纳难挠脑恼闹馁腻撵捻酿鸟聂啮镊镍柠狞宁拧泞钮纽脓浓农疟诺欧鸥殴呕沤盘庞国爱赔喷鹏骗飘频贫苹凭评泼颇扑铺朴谱脐齐骑岂启气弃讫牵扦钎铅迁签谦钱钳潜浅谴堑枪呛墙蔷强抢锹桥乔侨翘窍窃钦亲轻氢倾顷请庆琼穷趋区躯驱龋颧权劝却鹊让饶扰绕热韧认纫荣绒软锐闰润洒萨鳃赛伞丧骚扫涩杀纱筛晒闪陕赡缮伤赏烧绍赊摄慑设绅审婶肾渗声绳胜圣师狮湿诗尸时蚀实识驶势释饰视试寿兽枢输书赎属术树竖数帅双谁税顺说硕烁丝饲耸怂颂讼诵擞苏诉肃虽绥岁孙损笋缩琐锁獭挞抬摊贪瘫滩坛谭谈叹汤烫涛绦腾誊锑题体屉条贴铁厅听烃铜统头图涂团颓蜕脱鸵驮驼椭洼袜弯湾顽万网韦违围为潍维苇伟伪纬谓卫温闻纹稳问瓮挝蜗涡窝呜钨乌诬无芜吴坞雾务误锡牺袭习铣戏细虾辖峡侠狭厦锨鲜纤咸贤衔闲显险现献县馅羡宪线厢镶乡详响项萧销晓啸蝎协挟携胁谐写泻谢锌衅兴汹锈绣虚嘘须许绪续轩悬选癣绚学勋询寻驯训讯逊压鸦鸭哑亚讶阉烟盐严颜阎艳厌砚彦谚验鸯杨扬疡阳痒养样瑶摇尧遥窑谣药爷页业叶医铱颐遗仪彝蚁艺亿忆义诣议谊译异绎荫阴银饮樱婴鹰应缨莹萤营荧蝇颖哟拥佣痈踊咏涌优忧邮铀犹游诱舆鱼渔娱与屿语吁御狱誉预驭鸳渊辕园员圆缘远愿约跃钥岳粤悦阅云郧匀陨运蕴酝晕韵杂灾载攒暂赞赃脏凿枣灶责择则泽贼赠扎札轧铡闸诈斋债毡盏斩辗崭栈战绽张涨帐账胀赵蛰辙锗这贞针侦诊镇阵挣睁狰帧郑证织职执纸挚掷帜质钟终种肿众诌轴皱昼骤猪诸诛烛瞩嘱贮铸筑驻专砖转赚桩庄装妆壮状锥赘坠缀谆浊兹资渍踪综总纵邹诅组钻致钟么为只凶准启板里雳余链泄';
const zh_t = '皚藹礙愛翺襖奧壩罷擺敗頒辦絆幫綁鎊謗剝飽寶報鮑輩貝鋇狽備憊繃筆畢斃閉邊編貶變辯辮鼈癟瀕濱賓擯餅撥缽鉑駁蔔補參蠶殘慚慘燦蒼艙倉滄廁側冊測層詫攙摻蟬饞讒纏鏟産闡顫場嘗長償腸廠暢鈔車徹塵陳襯撐稱懲誠騁癡遲馳恥齒熾沖蟲寵疇躊籌綢醜櫥廚鋤雛礎儲觸處傳瘡闖創錘純綽辭詞賜聰蔥囪從叢湊竄錯達帶貸擔單鄲撣膽憚誕彈當擋黨蕩檔搗島禱導盜燈鄧敵滌遞締點墊電澱釣調叠諜疊釘頂錠訂東動棟凍鬥犢獨讀賭鍍鍛斷緞兌隊對噸頓鈍奪鵝額訛惡餓兒爾餌貳發罰閥琺礬釩煩範販飯訪紡飛廢費紛墳奮憤糞豐楓鋒風瘋馮縫諷鳳膚輻撫輔賦複負訃婦縛該鈣蓋幹趕稈贛岡剛鋼綱崗臯鎬擱鴿閣鉻個給龔宮鞏貢鈎溝構購夠蠱顧剮關觀館慣貫廣規矽歸龜閨軌詭櫃貴劊輥滾鍋國過駭韓漢閡鶴賀橫轟鴻紅後壺護滬戶嘩華畫劃話懷壞歡環還緩換喚瘓煥渙黃謊揮輝毀賄穢會燴彙諱誨繪葷渾夥獲貨禍擊機積饑譏雞績緝極輯級擠幾薊劑濟計記際繼紀夾莢頰賈鉀價駕殲監堅箋間艱緘繭檢堿鹼揀撿簡儉減薦檻鑒踐賤見鍵艦劍餞漸濺澗漿蔣槳獎講醬膠澆驕嬌攪鉸矯僥腳餃繳絞轎較稭階節莖驚經頸靜鏡徑痙競淨糾廄舊駒舉據鋸懼劇鵑絹傑潔結誡屆緊錦僅謹進晉燼盡勁荊覺決訣絕鈞軍駿開凱顆殼課墾懇摳庫褲誇塊儈寬礦曠況虧巋窺饋潰擴闊蠟臘萊來賴藍欄攔籃闌蘭瀾讕攬覽懶纜爛濫撈勞澇樂鐳壘類淚籬離裏鯉禮麗厲勵礫曆瀝隸倆聯蓮連鐮憐漣簾斂臉鏈戀煉練糧涼兩輛諒療遼鐐獵臨鄰鱗凜賃齡鈴淩靈嶺領餾劉龍聾嚨籠壟攏隴樓婁摟簍蘆盧顱廬爐擄鹵虜魯賂祿錄陸驢呂鋁侶屢縷慮濾綠巒攣孿灤亂掄輪倫侖淪綸論蘿羅邏鑼籮騾駱絡媽瑪碼螞馬罵嗎買麥賣邁脈瞞饅蠻滿謾貓錨鉚貿麽黴沒鎂門悶們錳夢謎彌覓綿緬廟滅憫閩鳴銘謬謀畝鈉納難撓腦惱鬧餒膩攆撚釀鳥聶齧鑷鎳檸獰甯擰濘鈕紐膿濃農瘧諾歐鷗毆嘔漚盤龐國愛賠噴鵬騙飄頻貧蘋憑評潑頗撲鋪樸譜臍齊騎豈啓氣棄訖牽扡釺鉛遷簽謙錢鉗潛淺譴塹槍嗆牆薔強搶鍬橋喬僑翹竅竊欽親輕氫傾頃請慶瓊窮趨區軀驅齲顴權勸卻鵲讓饒擾繞熱韌認紉榮絨軟銳閏潤灑薩鰓賽傘喪騷掃澀殺紗篩曬閃陝贍繕傷賞燒紹賒攝懾設紳審嬸腎滲聲繩勝聖師獅濕詩屍時蝕實識駛勢釋飾視試壽獸樞輸書贖屬術樹豎數帥雙誰稅順說碩爍絲飼聳慫頌訟誦擻蘇訴肅雖綏歲孫損筍縮瑣鎖獺撻擡攤貪癱灘壇譚談歎湯燙濤縧騰謄銻題體屜條貼鐵廳聽烴銅統頭圖塗團頹蛻脫鴕馱駝橢窪襪彎灣頑萬網韋違圍爲濰維葦偉僞緯謂衛溫聞紋穩問甕撾蝸渦窩嗚鎢烏誣無蕪吳塢霧務誤錫犧襲習銑戲細蝦轄峽俠狹廈鍁鮮纖鹹賢銜閑顯險現獻縣餡羨憲線廂鑲鄉詳響項蕭銷曉嘯蠍協挾攜脅諧寫瀉謝鋅釁興洶鏽繡虛噓須許緒續軒懸選癬絢學勳詢尋馴訓訊遜壓鴉鴨啞亞訝閹煙鹽嚴顔閻豔厭硯彥諺驗鴦楊揚瘍陽癢養樣瑤搖堯遙窯謠藥爺頁業葉醫銥頤遺儀彜蟻藝億憶義詣議誼譯異繹蔭陰銀飲櫻嬰鷹應纓瑩螢營熒蠅穎喲擁傭癰踴詠湧優憂郵鈾猶遊誘輿魚漁娛與嶼語籲禦獄譽預馭鴛淵轅園員圓緣遠願約躍鑰嶽粵悅閱雲鄖勻隕運蘊醞暈韻雜災載攢暫贊贓髒鑿棗竈責擇則澤賊贈紮劄軋鍘閘詐齋債氈盞斬輾嶄棧戰綻張漲帳賬脹趙蟄轍鍺這貞針偵診鎮陣掙睜猙幀鄭證織職執紙摯擲幟質鍾終種腫衆謅軸皺晝驟豬諸誅燭矚囑貯鑄築駐專磚轉賺樁莊裝妝壯狀錐贅墜綴諄濁茲資漬蹤綜總縱鄒詛組鑽緻鐘麼為隻兇準啟闆裡靂餘鍊洩';
String.prototype.tran = function () {
    var s1, s2;
    s2 = zh_s;
    s1 = zh_t;
    var a = '';
    var l = this.length;
    for (var i = 0; i < this.length; i++) {
        var c = this.charAt(i);
        var p = s1.indexOf(c);
        a += p < 0 ? c : s2.charAt(p);
    }
    return a;
}
let cmp = (x, y) => {
    // If both x and y are null or undefined and exactly the same
    if (x === y) {
        return true;
    }

    // If they are not strictly equal, they both need to be Objects
    if (!(x instanceof Object) || !(y instanceof Object)) {
        return false;
    }

    //They must have the exact same prototype chain,the closest we can do is
    //test the constructor.
    if (x.constructor !== y.constructor) {
        return false;
    }
    for (var p in x) {
        //Inherited properties were tested using x.constructor === y.constructor
        if (x.hasOwnProperty(p)) {
            // Allows comparing x[ p ] and y[ p ] when set to undefined
            if (!y.hasOwnProperty(p)) {
                return false;
            }
            // If they have the same strict value or identity then they are equal
            if (x[p] === y[p]) {
                continue;
            }
            // Numbers, Strings, Functions, Booleans must be strictly equal
            if (typeof (x[p]) !== "object") {
                return false;
            }
            // Objects and Arrays must be tested recursively
            if (!Object.equals(x[p], y[p])) {
                return false;
            }
        }
    }

    for (p in y) {
        // allows x[ p ] to be set to undefined
        if (y.hasOwnProperty(p) && !x.hasOwnProperty(p)) {
            return false;
        }
    }
    return true;
};


function setConfigSafe(key, val) {
    config.put(key, val);
    let tmp = config.get(key);
    if (cmp(tmp, val)) {
        toast("设置保存成功");
    } else {
        toast("设置保存失败！");
    };
};

//用户设置
function runSetup() {
    switch (dialogs.singleChoice("请选择一个设置，所有设置都会自动保存", ["查看当前设置", "更改消息模板", "更改停止次数", "调整发送速度", "调整点击位置", "切换自动重试", "恢复默认设置", "发送完成后操作", "查看获取坐标方法"])) {
        case 0: //查看当前设置
            dialogs.alert("暂时还没做好");
            break;
        case 1: //更改消息模板
            setConfigSafe("msgTemplate", dialogs.rawInput("输入你想发送的消息，$n代表当前发送的条数，$t代表当前时间，$p代表一句诗词", "当前是$t,第$n次，给你一句诗词:$p"));
            break;
        case 2: //更改停止次数
            setConfigSafe("maxCount", dialogs.input("输入发送自动停止时的条数，参考数据:刷友好度60，刷侠缘积分100，实际建议比参考数据稍高一点", "65"));
            break;
        case 3://调整发送速度
            setConfigSafe("sendDelay", dialogs.input("输入两次发送之间的延迟，单位:毫秒，如果对方在线建议1000，对方不在线建议4700，请按[<快速模式下速度>,<慢速模式下速度>]填写", "[1000,4700]"));
            break;
        case 4://调整点击位置
            setConfigSafe("clickPos", dialogs.input("按\"[[点击输入文字的方框正中间的x坐标,点击输入文字的方框正中间的y坐标],[发送按钮正中间的x坐标,发送按钮正中间的y坐标]]\"这个格式输入坐标，例如: [[1618,1173],[2197,1170]]", "[[0,0],[0,0]]"));
            break;
        case 5: //切换自动重试
            setConfigSafe("autoRetry", dialogs.confirm("", "是否在找不到输入框时不断尝试点击?"));
            break;
        case 6://恢复默认设置
            dialogs.alert("以后再完善这个功能");
            break;
        case 7://发送完成后操作
            setConfigSafe("endingInstruction", dialogs.singleChoice("选择发送完成后的操作..", ["无操作", "关闭屏幕(需要root)"]));
            break;
        case 8://查看获取坐标方法
            app.openUrl("https://jingyan.baidu.com/article/154b4631186be928ca8f412a.html")
            break;
    };
};

//获取一句诗词
function getPoem(logEnable) {
    let files_ = files.listDir("./gushi_json/", function (name) { return name.endsWith(".json") && files.isFile(files.join("./gushi_json/", name)); });
    let targetFileName = files_[Math.floor(Math.random() * files_.length)];
    let pstr = files.read("./gushi_json/" + targetFileName);
    let pjson = JSON.parse(pstr);
    let logmsg = "诗词选择器:";
    pjson = pjson[Math.floor(Math.random() * pjson.length)]; //选定1首
    logmsg += "在\"" + pjson.title.tran() + "\"(\"" + pjson.author.tran() + "\")中选定:"
    pjson = pjson.paragraphs;
    pstr = pjson[Math.floor(Math.random() * pjson.length)]; //选择内容中一句
    logmsg += pstr.tran();
    if (logEnable) console.info(logmsg);
    return pstr.tran(); //繁体变为简体
};

//发送消息给对方
function sendMessage(msg, timeOut) {
    let textBox;
    click(clickPos[0][0], clickPos[0][1]);
    sleep(400);
    while ((textBox = className("android.widget.EditText").findOne(timeOut)) == null && autoRetryEnabled) {
        console.info("找不到对话框，10秒后重试..")
        sleep(10000);
        click(clickPos[0][0], clickPos[0][1]);
        sleep(200);
    };
    textBox.setText(msg);
    className("android.widget.Button").text("确定").findOne().click();
    sleep(400);
    click(clickPos[1][0], clickPos[1][1]);
    return 1;

};


function startSending() {
    while (i < maxCount) {

        var msg = msg_;
        if (msg.indexOf("$t")) { //消息中有时间

            var myDate = new Date();
            var timeStr = myDate.toLocaleString();
            timeStr = timeStr.replace('GMT+', '');
            msg = msg.replace("$t", timeStr);

        };
        if (msg.indexOf("$p")) {
            msg = msg.replace("$p", getPoem(1))
        };

        if (msg.indexOf("$n")) {
            msg = msg.replace("$n", i)
        };
        if (sendMessage(msg, autoRetryEnabled ? 500 : 0)) i++;

        sleep(sendDelay);
    };


};


var config = storages.create("hallo1_familiarbooster_config");


console.info("\
1.为了点击屏幕和存储配置，本程序需要辅助功能和存储空间权限，这是必须的，剩下的权限拒绝就行\n\
2.你可以随时按音量上键结束运行\n\
3.脚本制作:声声慢:心慕流霞 李芒果，也强烈感谢auto.js作者提供的框架\n\
4.你可能想问这个脚本为什么这么大，其实是因为脚本里打包了大约30万首古诗。(其实也没必要搞这么多，不过我追求完美)\n\
5.如果脚本输出一些文字就没反应了，请允许脚本的悬浮窗权限！！(坑爹的小米手机)\
");

console.verbose("等待无障碍服务..");
auto.waitFor();
console.verbose("无障碍服务授权成功");

if (dialogs.singleChoice("君欲何为？", ["开始刷亲密度", "更改设置"])) {     //进入设置
    let endSetup = 0;
    while (!endSetup) {
        runSetup();
        endSetup = dialogs.singleChoice("继续设置吗？", ["继续设置", "退出，开始刷亲密度"])
    };
};

//选择发送速度
let delays = config.get("sendDelay", [1000, 4700]);
if (!(delays instanceof Array)) {
    console.error("请重新设定发送速度！");
    toast("请重新设定发送速度！");
    exit();
};


//选择已刷次数
var sendDelay = delays[dialogs.singleChoice("选择速度..", ["快速", "慢速"])];
var i = dialogs.input("输入今天已刷次数，如果之前没刷，请填写1", "1")

//如果选择刷完关屏,检测root权限
var screenOffEnabled = config.get("endingInstruction", 0);
if (screenOffEnabled) {
    if (shell("cat /proc/cmdline 1>/dev/null", true).error) {
        console.error("检测不到root权限!请关闭自动关屏设定");
        toast("检测不到root权限!请关闭自动关屏设定");
        exit();
    };
    var sh = new Shell(true);
};

var autoRetryEnabled = config.get("autoRetry", false);

var msg_ = config.get("msgTemplate", "请修改消息模板");
var maxCount = config.get("maxCount", 60);
var clickPos = config.get("clickPos", 0);

if (clickPos === 0) {
    dialogs.alert("请设置坐标！脚本将会退出");
    exit();
};

dialogs.alert("", "现在，打开游戏，点击输入框，如果遇到一些异常情况可以按音量上键结束脚本");
if (autoRetryEnabled) sleep(10000);
startSending();

if (screenOffEnabled) {
    sh.exec("input keyevent 26");

};